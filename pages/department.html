<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Department Dashboard - ResolveNOW</title>
  <link rel="stylesheet" href="../styles.css">
  <script src="../js/auth.js" defer></script>
  <script src="../js/admin-dashboard.js" defer></script>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <a href="../index.html"><h2>ResolveNOW</h2></a>
      </div>
      <div class="nav-menu">
        <span id="deptLabel" style="color: var(--medium-gray); font-weight: 500;"></span>
        <a href="#" onclick="logout()" class="btn-secondary">Sign Out</a>
      </div>
    </div>
  </nav>

  <div style="margin-top: 80px; padding: 40px 24px; max-width: 1400px; margin-left: auto; margin-right: auto;">
    <div style="margin-bottom: 40px;">
      <h1 id="deptTitle" style="color: var(--deep-blue); font-size: 32px; font-weight: 700; margin-bottom: 8px;">Department Dashboard</h1>
      <p id="deptSubtitle" style="color: var(--medium-gray);"></p>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; margin-bottom: 40px;">
      <div class="stat-card">
        <div class="stat-number" id="totalCases">0</div>
        <div>Total Cases</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pendingCases">0</div>
        <div>Pending Cases</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="activeCases">0</div>
        <div>Active Cases</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="resolvedCases">0</div>
        <div>Resolved Cases</div>
      </div>
    </div>

    <div class="cases-table">
      <div style="padding: 24px 24px 0;">
        <h3 id="casesHeader">Cases</h3>
        <p id="casesSubheader" style="color: var(--medium-gray); margin-top: 4px; font-size: 14px;"></p>
      </div>
      <table>
        <thead>
          <tr>
            <th>Case ID</th>
            <th>Complainant</th>
            <th>Counterparty</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Date Filed</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="casesTableBody">
          <tr>
            <td colspan="7" style="text-align: center; padding: 48px 24px; color: var(--medium-gray);">
              <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">ðŸ“‹</div>
              <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">No cases found</div>
              <div style="font-size: 14px;">Submitted disputes for your department will appear here</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Secure Supabase Evidence Manager for admin-case-details navigation -->
  <script src="../js/config.js"></script>
  <script type="module" src="../js/supabase-config.js"></script>
  <script type="module" src="../js/supabase-storage.js"></script>

  <script>
    const DEPT_META = {
      consumer: { label: 'Consumer Department', sub: 'Manage consumer complaints and disputes', tag: 'Consumer' },
      employment: { label: 'Employment Department', sub: 'Manage employment disputes and workplace issues', tag: 'Employment' },
      contract: { label: 'Contract Department', sub: 'Manage contract disputes and business agreements', tag: 'Contract' },
      property: { label: 'Property Department', sub: 'Manage property disputes and real estate conflicts', tag: 'Property' },
      business: { label: 'Business Department', sub: 'Manage business disputes and commercial conflicts', tag: 'Business' },
      family: { label: 'Family Department', sub: 'Manage family disputes and domestic conflicts', tag: 'Family' }
    };

    function ensureAdmin() {
      const userData = JSON.parse(localStorage.getItem('userData') || '{}');
      if (!userData || userData.userType !== 'admin' || !userData.department) {
        alert('Access denied. Department admin privileges required.');
        window.location.href = 'dashboard.html';
        return null;
      }
      return userData;
    }

    function setDeptUI(dept) {
      const meta = DEPT_META[dept] || { label: 'Department', sub: 'Manage cases', tag: 'Case' };
      document.getElementById('deptLabel').textContent = meta.label;
      document.getElementById('deptTitle').textContent = `${meta.label} Dashboard`;
      document.getElementById('deptSubtitle').textContent = meta.sub;
      document.getElementById('casesHeader').textContent = `${meta.tag} Cases`;
      document.getElementById('casesSubheader').textContent = `Review and manage ${meta.tag.toLowerCase()}-related cases`;
    }

    function storageKeyForDept(dept) {
      return `dept_${dept}_cases`;
    }

    function loadDepartmentCases() {
      const userData = ensureAdmin();
      if (!userData) return;
      const dept = userData.department;
      setDeptUI(dept);

      const key = storageKeyForDept(dept);
      const cases = JSON.parse(localStorage.getItem(key) || '[]');
      const tbody = document.getElementById('casesTableBody');
      if (cases.length === 0) return;

      tbody.innerHTML = '';
      cases.forEach(c => {
        const evidenceIcon = c.hasEvidence ? 'ðŸ“Ž' : '';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="font-weight: 600; color: var(--deep-blue);">${c.id} ${evidenceIcon}</td>
          <td>${c.submittedBy}</td>
          <td>${c.otherParty}</td>
          <td style="font-weight: 600; color: var(--deep-blue);">$${c.disputeAmount || '0'}</td>
          <td><span class="status-badge status-${(c.status||'Pending').toLowerCase()}">${c.status || 'Pending'}</span></td>
          <td style="color: var(--medium-gray);">${new Date(c.submittedAt).toLocaleDateString()}</td>
          <td>
            <button onclick="reviewCase('${c.id}', '${dept}')" style="background: none; border: none; color: var(--teal); cursor: pointer; font-weight: 500;">Review</button>
            <button onclick="resolveCase('${c.id}', '${dept}')" style="background: none; border: none; color: var(--success); cursor: pointer; font-weight: 500; margin-left: 8px;">Resolve</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById('totalCases').textContent = cases.length;
      document.getElementById('pendingCases').textContent = cases.filter(c => c.status === 'Pending').length;
      document.getElementById('activeCases').textContent = cases.filter(c => c.status === 'Active').length;
      document.getElementById('resolvedCases').textContent = cases.filter(c => c.status === 'Resolved').length;
    }

    function reviewCase(caseId, dept) {
      window.location.href = `admin-case-details.html?id=${caseId}&dept=${dept}`;
    }

    function resolveCase(caseId, dept) {
      const resolution = prompt('Enter resolution details:');
      if (resolution) {
        updateCaseStatus(caseId, dept, 'Resolved', resolution);
        alert(`Case ${caseId} has been resolved successfully!`);
      }
    }

    function updateCaseStatus(caseId, dept, newStatus, resolution = null) {
      const key = storageKeyForDept(dept);
      const deptCases = JSON.parse(localStorage.getItem(key) || '[]');
      const idx = deptCases.findIndex(c => c.id === caseId);
      if (idx !== -1) {
        deptCases[idx].status = newStatus;
        deptCases[idx].resolvedAt = new Date().toISOString();
        if (resolution) deptCases[idx].resolution = resolution;
        localStorage.setItem(key, JSON.stringify(deptCases));

        const userCases = JSON.parse(localStorage.getItem('userCases') || '[]');
        const uIdx = userCases.findIndex(c => c.id === caseId);
        if (uIdx !== -1) {
          userCases[uIdx].status = newStatus;
          userCases[uIdx].resolvedAt = new Date().toISOString();
          if (resolution) userCases[uIdx].resolution = resolution;
          localStorage.setItem('userCases', JSON.stringify(userCases));
        }

        loadDepartmentCases();
      }
    }

    async function logout() {
      await authManager.logout();
    }

    document.addEventListener('DOMContentLoaded', loadDepartmentCases);
  </script>
</body>
</html>
