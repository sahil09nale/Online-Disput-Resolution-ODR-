<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Details - ResolveNOW</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="../js/auth.js" defer></script>
    <script src="../js/case-details.js" defer></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="dashboard.html"><h2>ResolveNOW</h2></a>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html">Dashboard</a>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 100px; max-width: 1000px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1 id="caseTitle">Case Details</h1>
            <div>
                <span id="caseStatus" class="status-badge"></span>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <!-- Main Content -->
            <div>
                <!-- Case Information -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1.5rem; color: #1e293b;">Case Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <strong>Case ID:</strong>
                            <div id="caseId" style="color: #6b7280;"></div>
                        </div>
                        <div>
                            <strong>Type:</strong>
                            <div id="caseType" style="color: #6b7280;"></div>
                        </div>
                        <div>
                            <strong>Amount:</strong>
                            <div id="caseAmount" style="color: #6b7280;"></div>
                        </div>
                        <div>
                            <strong>Submitted:</strong>
                            <div id="caseDate" style="color: #6b7280;"></div>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">Description</h3>
                    <p id="caseDescription" style="line-height: 1.6; color: #374151;"></p>
                </div>

                <!-- Desired Outcome -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">Desired Outcome</h3>
                    <p id="caseOutcome" style="line-height: 1.6; color: #374151;"></p>
                </div>

                <!-- Evidence -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">Evidence</h3>
                    <div id="caseFiles">
                        <p style="color: #6b7280;">No evidence files uploaded</p>
                    </div>
                </div>

                <!-- Parties Information -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">Parties</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <strong>Applicant:</strong>
                            <div id="applicantName" style="color: #6b7280;"></div>
                            <div id="applicantEmail" style="color: #6b7280; font-size: 0.875rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- Resolution Section (hidden by default) -->
                <div id="resolutionSection" style="display: none; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">Resolution</h3>
                    <p id="resolutionText" style="line-height: 1.6; color: #374151; margin-bottom: 1rem;"></p>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        Resolved on: <span id="resolutionDate"></span>
                    </div>
                </div>

                <!-- Timeline -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 1.5rem; color: #1e293b;">Case Timeline</h3>
                    <div id="timeline" style="border-left: 3px solid #e5e7eb; padding-left: 1rem;">
                        <!-- Timeline items will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div>
                <!-- AI Analysis -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">ü§ñ AI Analysis</h3>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Case Category</h4>
                        <p id="aiCategory" style="color: #2563eb; font-weight: 600;"></p>
                    </div>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Complexity Score</h4>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div id="complexityBar" style="background: #e5e7eb; height: 8px; border-radius: 4px; flex: 1;">
                                <div style="background: #10b981; height: 100%; width: 60%; border-radius: 4px;"></div>
                            </div>
                            <span style="font-size: 0.875rem; color: #6b7280;">Medium</span>
                        </div>
                    </div>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                        <h4 style="font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem;">Estimated Resolution</h4>
                        <p style="color: #059669; font-weight: 600;">7-14 days</p>
                    </div>
                </div>

                <!-- Settlement Suggestions -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">üí° AI Settlement Suggestions</h3>
                    <div id="settlementSuggestions">
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                            <h4 style="font-size: 0.875rem; color: #92400e; margin-bottom: 0.5rem;">Recommended</h4>
                            <p style="font-size: 0.875rem; color: #78350f;">Partial refund with service improvement commitment</p>
                        </div>
                        <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #3b82f6;">
                            <h4 style="font-size: 0.875rem; color: #1e40af; margin-bottom: 0.5rem;">Alternative</h4>
                            <p style="font-size: 0.875rem; color: #1e3a8a;">Store credit with extended warranty</p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">Actions</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button id="refreshCaseBtn" class="btn-secondary" style="width: 100%;">üîÑ Refresh Case</button>
                        <button id="editCaseBtn" class="btn-primary" style="width: 100%; display: none;">Edit Case</button>
                        <button id="cancelCaseBtn" class="btn-secondary" style="width: 100%; display: none; background: #dc3545; color: white;">Cancel Case</button>
                        <button class="btn-primary" onclick="inviteOtherParty()" style="width: 100%;">Invite Other Party</button>
                        <button class="btn-secondary" onclick="requestMediator()" style="width: 100%;">Request Mediator</button>
                        <button class="btn-secondary" onclick="uploadAdditionalEvidence()" style="width: 100%;">Add Evidence</button>
                    </div>
                </div>

                <!-- Loading and Error Elements -->
                <div id="caseLoading" style="display: none; text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                    <div>Loading case details...</div>
                </div>
                
                <div id="caseError" style="display: none; background: #fee; color: #c33; padding: 16px; border-radius: 6px; margin: 20px 0; border: 1px solid #fcc;">
                    Error loading case details
                </div>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/case-details.js"></script>
    <script>
        // API-driven case details - NO localStorage usage
        async function initializePage() {
            try {
                // Check authentication via API
                if (!window.authManager) {
                    window.location.href = 'login.html';
                    return;
                }

                const authResult = await window.authManager.checkAuth();
                if (!authResult.success) {
                    window.location.href = 'login.html';
                    return;
                }

                // Initialize case details manager (this will load case data via API)
                if (window.caseDetailsManager) {
                    // Case details manager will handle everything
                    console.log('Case details manager initialized');
                } else {
                    console.error('Case details manager not available');
                }

            } catch (error) {
                console.error('Page initialization failed:', error);
                window.location.href = 'login.html';
            }
        }

        // All case data loading is now handled by js/case-details.js
        // No localStorage dependencies - purely API-driven

        function inviteOtherParty() {
            const email = prompt('Enter the other party\'s email address:');
            if (email) {
                alert(`Invitation sent to ${email}. They will receive an email with instructions to join the platform and respond to your dispute.`);
            }
        }

        function requestMediator() {
            alert('Mediator request submitted. A qualified mediator will be assigned to your case within 24 hours.');
        }

        function uploadAdditionalEvidence() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = '.pdf,.doc,.docx,.jpg,.jpeg,.png,.mp3,.mp4';
            input.onchange = function() {
                if (this.files.length > 0) {
                    alert(`${this.files.length} file(s) uploaded successfully. Evidence has been added to your case.`);
                }
            };
            input.click();
        }

        async function logout() {
            try {
                if (window.authManager) {
                    await window.authManager.logout();
                }
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'login.html';
            }
        }

        // Initialize page on load - API-driven approach
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>